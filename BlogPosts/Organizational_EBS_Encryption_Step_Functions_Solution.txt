<h2>How to Deploy the cross-account encryption process</h2>

This solution is a step functions workflow made up of 5 Lambda functions which carry out the process of encrypting EBS Volumes within an account based on a tag value. It is designed to work in the following way.<br><br>
Within this directory, you will find all the code files, the cloudformation template, and a diagram of the solution.<br>

Attached below is an interactive diagram: <br>

<iframe frameborder="0" style="width:100%;height:500px;" src="https://viewer.diagrams.net/?highlight=0000ff&nav=1#R7V1tc5s4EP41%2BdgM7%2BCPiZ3c3Ux7l6tvpnefOgrINheMPCDX8f36kwBhhGSDa2NwrLTTmLUQsLvPs9JKbO%2FM8fL9lwSsFl9QAKM7Qwve78zJnWHoI3tEflHJNpeYlu7kknkSBkWrnWAa%2FgcLoVZI12EAU64hRijC4YoX%2BiiOoY85GUgStOGbzVDEX3UF5lAQTH0QidJvYYAXudTStJ38VxjOF7j2xRKwtoUgXYAAbSoi8%2BnOHCcI4fzT8n0MI6o8ppb8vOc935b3lcAYtzrhYeG%2F%2FP7p%2BXH8n7Xy%2F3z7Zv796yevuLkfIFoXD1zcLd4yDcwTtF4VzWCC4btM7%2BCVNdfEG9PLxyV%2BAtES4mRLmhQdGUxlhYt8MoxRIdnsNO7pVi5bVLStm2bREhRmnpfd71RBPhTaOEIzuqCYLyDFMCGyF7DNfj%2F4PlqTZ6wrbIXCGGf3Yz%2BSv%2BQOx9qdTb4Z06N7w64J6scuL9DFI9oHL6gfu7xAr3ev166v12%2BwIhCOuO612vW1yg2Sv%2BYjWuMojOG4BKhGhPMEBCFxkDGKUEJkMYqJ9h4XeEmsNNHJx80ixHC6Aj7V6oawC5HNUIwLitANdlwonvZKnBEDcq2k6COzBEyefsDcIHmbKAKrNHwtz0qgv07S8Af8CtO8cyoleF3Rz8v3OaW2e7BJrfscC%2FT2fyPXkn77HRRuQbrACXqD7BHvDHM8MQzHojceRlHt0Sm2QsI7D1E4pz1jRC8EiiMf0gehfRKNhPH8M5xRVZpaoQXZRQKQLmBQPM5eAHNA3c8R%2B%2BHrjQSwlixQBavRGVYNAasP36ZEMI7QOnhGCeHikFirjtP0DWJ%2FUehHClopcGXglQJYBDHXLIOV5Ap1oUzmikJdbMaQKAplMhnt1M%2FWJWfrtbMz0Ct1nlWdUg6t4Z78eaag4ciFyJ9c3XYfZXQ0y37qTMGI6DN4hdELSsMMPObkFWGMlu2ZqsLlTbwN0lX%2BWLPwnd6HnHwTmKJ14sOcegltpzIS9inoZyXoT2G%2Bw%2BMWz%2BCGLZYl0KAjYUGnKxI0BRKcYuC%2FEdEUimMUjvuO8q49kbud0xWNB%2Bdv9YGCvs8H00ynF3Mq3RJHwo5%2Bb3sXdCxLHAnD5Ss%2FAtb%2BIHZV42A1Du56HBxl494BjYILoJbwqwDV9CT8r2tuV0B1xGFwiU8VC4YYC6yDsUBnnsJGGP3HApaVO5QvIuCPg9KiMvqqWkckgNIh9A51a%2FKqlcVZUzaJHWmdqVbMOOWz2CmGK%2FLreR37FA0pvUuUvM0itFEhV4VcLuRu0u8pcZfvM%2BYs30tX%2BRhh%2BDCq7RqqJUFZNyWo9uzOUC3mpkgoTsQgTPoKVymsWD9Aa%2BIoT6W84qCcMmXeKgS1WkieeT70fZlPvHq2ZZ9mI%2F3wFMeyOSO5oo0siYmsrixkOKItgjlk2EYJXqA5ikH0tJM%2B8jFu1%2BYzojDJbPQvxHhbMAZYY8RbML8mvdB5dJvACGDCI1xvMl0Vp75QetrZxLHunVH1hzORsMqS52GKPqprTsd1Wx8JE2DMIRa6fUgSsK00K4Lczz6MrZ1yz%2FzZ5EN%2Bdzv%2FK41ygkuOlEtSO3hVM3j8WLjOB0e45KFuvc5c8tBVnUaXbH92Ny5p2kIce4oDFcXKKCZZsr5oGDMtxRkZUKpIcXgb1Ud5x3DGgW5H3XHGgau6zZzR%2BuyOOENckhB8VK3B1ie3t71oeMmVwjROm%2Bf9EX0gQo0BTGoz5Pwb4L%2FNMxpl3wZwBtYR7jT2ZObn5lC6GH1Gkugz6ij66OLwYEotbGi%2FxSkGsQ9TBf1rgf7E1TXt8tDvab9ABJavAegwKcWGB2wGqYsjRVsyUuwuJXVVCQ82rM0seeipirFFPvhqpKoThp6nKX8kEOUEYkB4kFyMTqi0aQxW6QI1LNMpvlR8eRt8aRk986Vk1jJ0vjz7xFrX%2BQGnWc%2BTtZ1K1zsqrXvmybNwHe3wdLmhfUd5XnGCPEYr%2Bph3hgOWGeqzf4nkKfaT7UpFBRUVVFSgbG%2F2HRU8AbtfYYpRAqXw%2FQoBzod5Cr8Kvwq%2FjiVmrC6KX8YfVfyuY5WwUlBVUOWh6kp2UV0Wqr1MwIgGk%2B3f9Hziv8XhP0V32cHknTvaVo9eYBKSh892A%2B6WoX86%2B9WY1DL37E4%2Fedpn3XtWZRXR5T1Dr5m8%2FSzwcL91V%2BpoUuial1gFdYVAIy6NaF9RJL5A0%2FXG%2FMnEtKyxQJxXvzE%2FQRkFdMWPhrnbdV8m9b17zRVoUvYCoGnee3ZXTOn1ypQ6x5M72rwgUzauEzA4DnydwDzTOoFijWGxhrb7sTgGsQzKIMK20x7JhG1VU2TSiNJmMhn1SSbW9a1gtFA%2ByyA0Kj9Ps%2FemfPG9rtOS%2FIrSr4TSbXNwlC4uOFWT1nyiWs1JPo4rOtZoaK7Yy371qxpdMLQ2Bziv1wAn1h0QMumKSz4Ol7jO4MKaq7ikiUucllxycib5JEva%2Fc45j0z1%2F6zR2Oap5k2tLY12lk1fR2fTa%2BtELLveaTbdFmdTkmpUf22Q4EeqNMZtl8a4iWpU7AUhkw%2FZQ6hOZRsCclV5qmGXp7IPv4Y2wPpUdotXTgdSn6pBucMrUGWLhSBVgSoVhVWBqmNgPbwKVbbs1d0PXqHKPpwAGViFKvuqXtjcp1tVoar1VYdfocruJeM2PJdUFap%2B4uyOXFJ8IeeDV6g6Mor1XaGK%2FVdgN88ZqkLV8Wd3wxls9K0qVF3hWz%2BqQlWPFaqaYs%2FgKlQ54sKRqlB1rdBXL%2FydNys1tBJVjhiGhzxULBo2LuezVFvjer6zx1yX2YThiIsoqkaVYkzFmAMuUuVcVfnnfcpVVaoOT5l7qVLliAtEqkqVigsqLlxDmSpHsjlflalSAFYAvpI6VY5YPkTVqVJYVVgVsdp7oSqn3%2FIrfRaqYjmw5tSW29HUT1WqOnmiJ9acUZWqBv4mZwNDDrdUFdtZd4PvbLZeL2CAHPh6gSsurapaVR%2BBN66oWJXby4rhddGJ23qM1mvBJNfsw5Tda79tLVen18KD7DZVuaqbY%2FXh1atyxaUnVa%2FqJnxxeAWr3F7ewrqyEUbrDU5OrzGuRU5dsckHYpPhlaxyb7dSd3s2aVuq%2B%2BSc8mmmvKr3ms5ee%2Bo8e7mOfvXI4BF%2BYvEpcpgghKvNKXl9QQGkLf4H"></iframe>

Here's a link to the original GitHub link with the source code: <br>

<a href="https://github.com/jacklavelle286/ebs-encryption/blob/main/README.md">Source Code on Github.com</a>

<h2>Prerequisites</h2>

<br>1. Upload the 5 code files to an S3 bucket within a delegated administrator account / the master payer account and give it a bucket policy which allows it to be accessed by lambda functions across your org / accounts you want to specify.  See bucket-policy.json as an example.<br><br>

Add in your organization id and your bucket name in the corresponding places. This will ensure that each stack will be able to use the exact same code regardless of which account it is deployed in, ensuring consistency. <br>

<br>2. Tag a maximum of 20 EC2 instances which you intend to encrypt with any of the following tags:<br>

- Batch1:true
<br>
- Batch2:true
<br>
- Batch3:true
<br>
- Batch4:true
<br>
- Batch5:true
<br>
- Batch6:true
<br>
- Batch7:true
<br>
- Batch8:true<br>

The idea is that each time you deploy the cloudformation stack, you select a 'Batch' as a parameter when launching the stack, and this corresponds to a batch of EC2 instances to encrypt. <br>

<h2>Deployment steps</h2>

<br>1. Deploy your cloudformation template as a Stack set within your delegated administrator account / in the master payer account using service-managed permissions - and choose to share the stack either across your entire organization or a particular OU - depending on how you want to deploy this solution. <br><br>

2. When you launch the stack you will provide the stack name, the bucket name of the bucket which you uploaded your code to, your tag value for the EC2 instances, and the email address you would like to be notified on when the process has completed via SNS. <br>

3. Once deployed, log into your corresponding account and run the step corresponding step functions state machine - and following the workflow, you should see the following process happen:<br>

- Stop all instances with the corresponding tag
<br>
- Detach the EBS volumes (remembering the block device mapping of the volume)
<br>
- create a snapshot of the volume
<br>
- copy the snapshot and encrypt it using the default KMS key
<br>
- restore the volume from the snapshot
<br>
- reattach the restored encrypted volume to the original instance (via the same block device mapping)
<br>
- run the instances 

